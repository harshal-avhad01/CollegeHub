<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CampusHub ‚Äì My Profile</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root {
  --primary: #5E35B1; --secondary: #7E57C2; --bg1: #f3e9fb; --bg2: #ede7f6;
  --muted: #6b7280; --text: #111; --card-bg: rgba(255,255,255,0.92);
  font-family: 'Poppins', sans-serif;
}
body.dark {
  --bg1:#1b132d; --bg2:#2a1f47; --text:#f3e9fb; --muted:#d1c4e9;
  --card-bg:rgba(46,34,72,0.9); --shadow:rgba(0,0,0,0.6);
}
body {
  margin: 0; color: var(--text); background: linear-gradient(120deg, var(--bg1), var(--bg2));
  overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column;
  position: relative; transition: background-color 0.3s, color 0.3s;
}
header {
  height: 70px; background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff; display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; box-shadow: 0 6px 20px rgba(94,53,177,0.25);
  position: sticky; top: 0; z-index: 100;
}
.brand {
  display: flex; align-items: center; gap: 12px; font-weight: 600;
  font-size: 1.3rem; color: #fff; text-decoration: none;
}
header nav a {
  color: #fff; text-decoration: none; margin-left: 22px;
  font-weight: 500; opacity: 0.9; transition: opacity 0.3s;
}
header nav a:hover { opacity: 1; }
#themeToggle {
  cursor: pointer; font-size: 1.3rem; color: #fff; background: none;
  border: none; margin-left: 20px; transition: transform 0.3s;
}
#themeToggle:hover { transform: rotate(20deg); }
main {
  flex: 1; display: flex; justify-content: center; align-items: center;
  max-width: 700px; margin: 50px auto; padding: 0 20px;
  position: relative; z-index: 5;
}
.card {
  width: 100%;
  position: relative; background: var(--card-bg); border-radius: 20px;
  padding: 40px 36px; box-shadow: 0 20px 50px rgba(94,53,177,0.2);
  backdrop-filter: blur(12px); overflow: hidden; border: 1px solid var(--border-color);
}
body.dark .card { box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
.card h2 { color: var(--primary); margin-bottom: 8px; }
body.dark .card h2 { color: var(--secondary); }
.card p { color: var(--muted); margin-bottom: 25px; }

form { display: flex; flex-direction: column; gap: 18px; }
.input-group { position: relative; }
input, select, textarea {
  width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd;
  font-size: 0.95rem; background: var(--bg1); color: var(--text);
  transition: 0.3s; font-family: 'Poppins', sans-serif;
}
body.dark input, body.dark select, body.dark textarea { border-color: #4a3a6b; background: var(--bg1); }
input:focus, select:focus, textarea:focus {
  border-color: var(--primary); box-shadow: 0 0 10px rgba(94,53,177,0.3);
  outline: none; background: var(--card-bg);
}
label {
  position: absolute; left: 14px; top: 14px; color: var(--muted);
  pointer-events: none; transition: 0.3s ease; background: var(--bg1); padding: 0 6px;
}
body.dark label { background: var(--bg1); }
input:focus + label, input:not(:placeholder-shown) + label,
select:focus + label, select:valid + label,
textarea:focus + label, textarea:not(:placeholder-shown) + label {
  top: -9px; font-size: 12px; color: var(--primary); background: var(--card-bg);
}
body.dark input:focus + label, body.dark input:not(:placeholder-shown) + label,
body.dark select:focus + label, body.dark select:valid + label,
body.dark textarea:focus + label, body.dark textarea:not(:placeholder-shown) + label {
    background: var(--bg2);
}
input[type="file"] { display: none; }
.file-upload-label {
    display: block; width: 100%; padding: 12px; border: 2px dashed var(--border-color);
    border-radius: 8px; text-align: center; font-weight: 500; color: var(--text-light);
    cursor: pointer; transition: all 0.3s ease;
}
.file-upload-label:hover {
    border-color: var(--primary); background-color: var(--bg1); color: var(--primary);
}
#file-name-display { font-size: 0.85rem; color: var(--text-light); margin-top: -10px; margin-bottom: 10px; }
.profile-pic-preview {
    width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--primary); margin: 0 auto 15px; display: block;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
textarea { resize: vertical; min-height: 80px; }

button[type="submit"] {
  margin-top: 8px; background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff; border: none; border-radius: 12px; padding: 14px;
  font-weight: 600; cursor: pointer; transition: all 0.3s;
  box-shadow: 0 8px 22px rgba(94,53,177,0.25);
  font-family: 'Poppins', sans-serif; font-size: 1rem;
}
button[type="submit"]:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 28px rgba(94,53,177,0.35); 
}
#message {
    text-align: center; font-weight: 500;
    margin-top: 15px; font-size: 0.95rem;
}
footer { text-align: center; color: var(--muted); font-size: 0.85rem; padding: 14px 0 20px; }
canvas#particles {
  position: fixed; top: 0; left: 0; z-index: -1;
  width: 100%; height: 100%; pointer-events: none;
}
</style>
</head>

<body>
<canvas id="particles"></canvas>
<!-- Note: Removed background shapes for a cleaner profile page, can be added back if desired -->

<header>
  <a href="campushub.html" class="brand"><i class="fa-solid fa-graduation-cap"></i> CampusHub</a>
  <nav>
    <a href="campushub.html">Home</a>
    <a href="contact.html">Contact</a>
    <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>
  </nav>
</header>

<main>
  <section class="card">
    <img src="https://placehold.co/100x100/5E35B1/FFFFFF?text=U" alt="Profile Picture" class="profile-pic-preview" id="profile-pic-preview">
    <h2>My Profile</h2>
    <p>Update your public profile information.</p>

    <form id="profileForm">
      <div class="input-group">
        <input type="text" id="fullname" placeholder=" " required>
        <label for="fullname">Full Name</label>
      </div>
      <div class="input-group">
        <input type="email" id="email" placeholder=" " disabled>
        <label for="email">College Email (Cannot be changed)</label>
      </div>
      
      <label for="profile-pic-input" class="file-upload-label">
        <i class="fa-solid fa-camera"></i> Change Profile Picture
      </label>
      <input type="file" id="profile-pic-input" accept="image/*">
      <span id="file-name-display">No new file chosen</span>
      
      <div class="input-group">
        <select id="dept" required>
          <option value="" disabled selected hidden></option>
          <option value="Computer Science">Computer Science</option>
          <option value="Electronics">Electronics</option>
          <option value="Physics">Physics</option>
          <option value="Mathematics">Mathematics</option>
          <option value="Commerce">Commerce</option>
        </select>
        <label for="dept">Department</label>
      </div>
      <div class="input-group">
        <select id="year" required>
          <option value="" disabled selected hidden></option>
          <option value="FY">FY</option>
          <option value="SY">SY</option>
          <option value="TY">TY</option>
          <option value="Final Year">Final Year</option>
        </select>
        <label for="year">Year</label>
      </div>
      <div class="input-group">
        <textarea id="bio" placeholder=" "></textarea>
        <label for="bio">Your Bio (Optional)</label>
      </div>
      
      <button type="submit" id="update-profile-btn">Update Profile</button>
    </form>
    <p id="message"></p>
  </section>
</main>

<footer>¬© 2025 CampusHub | Designed for Connected Campuses üíú</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://tuucgqbyegerndyviefw.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1dWNncWJ5ZWdlcm5keXZpZWZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTc1NTksImV4cCI6MjA3NzEzMzU1OX0.fImUoHr86_5MdkDEWu8JXhjSaG2oxbq0IoGhZ6XeH-0";

  let supabaseClient;
  let currentUser = null;

  const form = document.getElementById("profileForm");
  const msg = document.getElementById("message");
  const updateBtn = document.getElementById("update-profile-btn");
  
  // Form Fields
  const fullNameInput = document.getElementById("fullname");
  const emailInput = document.getElementById("email");
  const deptInput = document.getElementById("dept");
  const yearInput = document.getElementById("year");
  const bioInput = document.getElementById("bio");
  const profilePicInput = document.getElementById("profile-pic-input");
  const profilePicPreview = document.getElementById("profile-pic-preview");
  const fileNameDisplay = document.getElementById("file-name-display");


  function setStatus(text, isError = false) {
      msg.textContent = text;
      msg.style.color = isError ? 'red' : 'green';
  }

  // 1. Initialize Supabase and check auth
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    checkUser();
  

  // 2. Check for logged in user
  async function checkUser() {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    if (error) {
      setStatus("Error loading session.", true);
    } else if (!session) {
      // Not logged in, redirect to login
      window.location.href = 'index.html';
    } else {
      currentUser = session.user;
      loadProfile();
    }
  }

  // 3. Load user data into the form
  async function loadProfile() {
    if (!currentUser) return;
    
    // Load from auth metadata (set during registration)
    const metadata = currentUser.user_metadata;
    emailInput.value = currentUser.email;
    fullNameInput.value = metadata.fullname || '';
    deptInput.value = metadata.dept || '';
    yearInput.value = metadata.year || '';
    
    // Load profile picture from metadata
    if (metadata.profile_image) {
        profilePicPreview.src = metadata.profile_image;
    } else {
        const initials = (metadata.fullname || currentUser.email)[0].toUpperCase();
        profilePicPreview.src = `https://placehold.co/100x100/5E35B1/FFFFFF?text=${initials}`;
    }

    // Load from 'user_profiles' table (bio)
    // Assumes a 'user_profiles' table with RLS policy:
    // "Users can view and update their own profile." (uid = user_id)
    const { data, error } = await supabaseClient
        .from('user_profiles')
        .select('bio')
        .eq('user_id', currentUser.id)
        .single();
        
    if (data) {
        bioInput.value = data.bio || '';
    } else if (error && error.code !== 'PGRST116') {
        // PGRST116 = row not found, which is fine
        console.error("Error loading bio:", error);
        setStatus("Could not load profile bio.", true);
    }
  }

  // 4. Handle Profile Picture File Selection
  profilePicInput.addEventListener('change', () => {
      if (profilePicInput.files.length > 0) {
          const file = profilePicInput.files[0];
          fileNameDisplay.textContent = file.name;
          // Show a local preview
          const reader = new FileReader();
          reader.onload = (e) => {
              profilePicPreview.src = e.target.result;
          };
          reader.readAsDataURL(file);
      } else {
          fileNameDisplay.textContent = 'No new file chosen';
      }
  });

  // 5. Handle Form Submission
  form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser || !supabaseClient) return;
      
      setStatus("‚è≥ Updating profile...", false);
      updateBtn.disabled = true;
      updateBtn.textContent = "Updating...";

      try {
          let profileImageUrl = currentUser.user_metadata.profile_image; // Keep old one by default
          const newProfilePic = profilePicInput.files[0];

          // 5a. Upload new profile picture if one is selected
          if (newProfilePic) {
              const filePath = `avatars/${currentUser.id}/${Date.now()}-${newProfilePic.name}`;
              
              // Use upsert to overwrite any existing file (or create new)
              const { data: uploadData, error: uploadError } = await supabaseClient
                  .storage
                  .from('avatars') // Assumes 'avatars' storage bucket
                  .upload(filePath, newProfilePic, {
                      cacheControl: '3600',
                      upsert: true 
                  });
              
              if (uploadError) throw uploadError;
              
              // Get public URL
              const { data: urlData } = supabaseClient
                  .storage
                  .from('avatars')
                  .getPublicUrl(filePath);
              profileImageUrl = urlData.publicUrl;
          }

          // 5b. Update auth metadata (name, dept, year, new pic URL)
          const { data: userUpdate, error: authError } = await supabaseClient.auth.updateUser({
              data: {
                  fullname: fullNameInput.value,
                  dept: deptInput.value,
                  year: yearInput.value,
                  profile_image: profileImageUrl
              }
          });
          
          if (authError) throw authError;
          
          // 5c. Update 'user_profiles' table (bio)
          // Use 'upsert' to create a profile row if it doesn't exist, or update if it does
          const { error: profileError } = await supabaseClient
              .from('user_profiles')
              .upsert({ 
                  user_id: currentUser.id, 
                  bio: bioInput.value,
                  // We also store social_links, interests here from your schema
              }, {
                  onConflict: 'user_id' // Specify the column to check for conflict
              });
              
          if (profileError) throw profileError;
          
          setStatus("‚úÖ Profile updated successfully!", false);
          // Update current user data in case they refresh
          currentUser = userUpdate.user; 

      } catch (error) {
          console.error("Error updating profile:", error.message);
          setStatus(`‚ùå Error: ${error.message}`, true);
      } finally {
          updateBtn.disabled = false;
          updateBtn.textContent = "Update Profile";
      }
  });
  
</script>
  
<script>
// üåô DARK / LIGHT MODE
const themeBtn = document.getElementById('themeToggle');
const body = document.body;
if (localStorage.getItem('theme') === 'dark') {
  body.classList.add('dark');
  if(themeBtn) themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
}
if(themeBtn) {
    themeBtn.onclick = () => {
      body.classList.toggle('dark');
      if (body.classList.contains('dark')) {
        themeBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
        localStorage.setItem('theme', 'dark');
      } else {
        themeBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
        localStorage.setItem('theme', 'light');
      }
    };
}
// No particles on this page for a cleaner look
</script>
</body>
</html>
